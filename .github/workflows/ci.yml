name: CI/CD Pipeline

# Khi nào chạy workflow này?
on:
  push:
    branches: [ master, main ]  # Khi push code lên master hoặc main
  pull_request:
    branches: [ master, main ]   # Khi tạo Pull Request vào master/main

jobs:
  # Job 1: Test và Build Server (Backend)
  test-server:
    name: Test & Build Server
    runs-on: ubuntu-latest        # Chạy trên máy Ubuntu (miễn phí từ GitHub)
    
    services:
      # Tạo PostgreSQL container để test
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      # Tạo Redis container để test
      redis:
        image: redis:alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      # Bước 1: Checkout code từ GitHub
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Bước 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json
      
      # Bước 3: Install dependencies cho server
      - name: Install server dependencies
        working-directory: ./server
        run: npm ci  # npm ci nhanh hơn và đảm bảo chính xác hơn npm install
      
      # Bước 4: Chạy linter (nếu có)
      - name: Run server linter
        working-directory: ./server
        run: |
          if npm run lint 2>/dev/null; then
            npm run lint
          else
            echo "No lint script found, skipping..."
          fi
        continue-on-error: true
      
      # Bước 5: Initialize test database schema
      - name: Initialize test database schema
        working-directory: ./server
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: |
          npm run init:db || echo "Schema initialization completed"
        continue-on-error: true
      
      # Bước 6: Chạy tests
      - name: Run server tests
        working-directory: ./server
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          TEST_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: test_db
          DB_HOST: localhost
          DB_PORT: 5432
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key-for-ci
        run: npm test
      
      # Bước 6: Build server (kiểm tra có lỗi syntax không)
      - name: Build server check
        working-directory: ./server
        run: |
          echo "Checking server syntax..."
          node --check server.js || echo "Server syntax check completed"

  # Job 2: Test và Build Client (Frontend)
  test-client:
    name: Test & Build Client
    runs-on: ubuntu-latest
    
    steps:
      # Bước 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Bước 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: client/package-lock.json
      
      # Bước 3: Install dependencies cho client
      - name: Install client dependencies
        working-directory: ./client
        run: npm ci
      
      # Bước 4: Chạy linter
      - name: Run client linter
        working-directory: ./client
        run: npm run lint
        continue-on-error: true
      
      # Bước 5: Build client (kiểm tra có build được không)
      - name: Build client
        working-directory: ./client
        run: npm run build
      
      # Bước 6: Upload build artifacts (để có thể download sau)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: client-build
          path: client/dist
          retention-days: 7

  # Job 3: Build Docker images (tùy chọn)
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-server, test-client]  # Chỉ chạy sau khi test thành công
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build server Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.server
          push: false  # Không push lên Docker Hub (có thể bật sau)
          tags: warehouse-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build client Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.client
          push: false
          tags: warehouse-client:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Job 4: Deploy (tùy chọn - chỉ chạy khi push lên master)
  # deploy:
  #   name: Deploy to Production
  #   runs-on: ubuntu-latest
  #   needs: [test-server, test-client, build-docker]
  #   if: github.ref == 'refs/heads/master' && github.event_name == 'push'
  #   
  #   steps:
  #     - name: Deploy to server
  #       run: |
  #         echo "Deploy code here..."
  #         # Ví dụ: SSH vào server và pull code mới
  #         # hoặc deploy lên VPS, AWS, Heroku, etc.
